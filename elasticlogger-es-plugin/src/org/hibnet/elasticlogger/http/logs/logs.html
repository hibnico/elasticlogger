<script type="text/javascript">
var logTimelineChart;
$(document).ready(function() {
	if (!window.WebSocket) {
		alert("You need a modern web brower which supports WebSockets in order to use this service.\nYou can find one there: http://www.google.com/chrome");
	} else {
		searchSocket.load();
	}
	logTimelineChart = new Highcharts.Chart({
        chart: {
            renderTo: 'logsTimeline',
            defaultSeriesType: 'column',
            margin: [ 50, 50, 100, 80]
         },
         title: {
            text: ''
         },
         xAxis: {
            categories: [],
            labels: {
               rotation: -45,
               align: 'right',
               style: {
                   font: 'normal 13px Verdana, sans-serif'
               }
            }
         },
         yAxis: {
            min: 0,
            title: {
               text: ''
            }
         },
         legend: {
            enabled: false
         },
         tooltip: {
            formatter: function() {
               return this.y;
            }
         },
         series: [{
            name: 'Logs',
            data: [],
            dataLabels: {
               enabled: true,
               rotation: -90,
               color: '#FFFFFF',
               align: 'right',
               x: -3,
               y: 10,
               formatter: function() {
                  return this.y;
               },
               style: {
                  font: 'normal 13px Verdana, sans-serif'
               }
            }         
         }]
      });
});

searchSocket = {
    _ws: null,
    load: function() {
    	var url = "ws:" + document.URL.substring(document.URL.indexOf("//"), document.URL.lastIndexOf("/")) + "/search";
        this._ws = new WebSocket(url);
        this._ws.onopen = this._onopen;
        this._ws.onmessage = this._onmessage;
        this._ws.onclose = this._onclose;
    },
    _onopen: function() {
        $("#searchInput #connectionStatus").text("connected");
        var date = new Date();
        $("#searchInput #connectionStatus").attr("title", "at " + date.getHours() + "h" + date.getMinutes() + ":" + date.getSeconds() + "s");
    },
    _onclose: function() {
        this._ws = null;
        $("#searchInput #connectionStatus").text("disconnected");
        var date = new Date();
        $("#searchInput #connectionStatus").attr("title", "at " + date.getHours() + "h" + date.getMinutes() + ":" + date.getSeconds() + "s");
        setTimeout("searchSocket.load()", 5000); // try to reconnect
    },
    _onmessage: function(m) {
    	var searchResponse = $.parseJSON(m.data);
    	$("#resultsMessage").text(searchResponse.hits.total + " logs found in " + searchResponse.took + " ms");
    	emptyFacets();
        showFacets(searchResponse.facets);
    	emptyLogs();
    	showLogs(searchResponse.hits.hits);
    },
    send: function(data) {
    	this._ws.send($.toJSON(data));
    }
}

function launchSearch() {
    var query = $("#searchInput #query").val();
    var searchQuery = { "query": query };
    searchSocket.send(searchQuery);
}

var tailSearchActive = false;

function toggleTailSearch() {
	tailSearchActive = !tailSearchActive;
	if (tailSearchActive) {
		tailSearch();
	}
}

function tailSearch() {
	launchSearch();
    if (tailSearchActive) {
        setTimeout("tailSearch()", 5000);
    }
}

function emptyLogs() {
	$("#searchResults #searchResultsContent tr").remove();
}
function showLogs(results) {
	var searchResultsElement = $("#searchResults #searchResultsContent");
	var even = true;
    for (var i = 0; i < results.length; i++) {
        var log = results[i]._source;
        var date = new Date();
        date.setTime(log.timestamp);
        var dateString = "";
        dateString = dateString + (date.getDate() < 10 ? "0" : "") + date.getDate();
        dateString = dateString + "/" + (date.getMonth() < 10 ? "0" : "") + date.getMonth();
        dateString = dateString + "/" + date.getYear();
        dateString = dateString + " " + (date.getHours() < 10 ? "0" : "") + date.getHours();
        dateString = dateString + ":" + (date.getMinutes() < 10 ? "0" : "") + date.getMinutes();
        dateString = dateString + ":" + (date.getSeconds() < 10 ? "0" : "") + date.getSeconds();
        searchResultsElement.append("<tr id='" + results[i]._id + "' class='" + (even ? "even" : "odd") + " " + log.level + "'>"
            + "<td>" + i + "</td><td>" + dateString + "</td><td>"
            + log.threadname + "</td><td>" + log.level + "</td><td>"
            + log.loggername + "</td><td>" + log.message + "</td></tr>");
        even = !even;
    }
}

facetNames = {
    "level" : "Levels",
    "threadname" : "Thread Names",
    "loggername" : "Logger Names"
}
function emptyFacets() {
    $(".results .results_header #searchFacets").remove();
}
function showFacets(facets) {
    var resultsHeaderElement = $(".results .results_header");
    for (facet in facets) {
    	if (facet == "dateHistogram") {
    		chart.series[0].remove(false);
    		var data = [];
    		chart.series[0].setData(data, true);
    	} else {
            var facetValues = "";
            for (var i = 0; i < facets[facet].terms.length; i++) {
                facetValues = facetValues + "<li>" + facets[facet].terms[i].term + " (" + facets[facet].terms[i].count + ")</li>";
            }
            resultsHeaderElement.append("<div class='facets'>" + facetNames[facet] + ": <ul>" + facetValues + "</ul></div>");
        }
    }
    resultsHeaderElement.append("<div class='clear'></div>");
}
</script>
<div id="searchInput">
      Search:
      <input id="query" type="text" name="query" size="100" />
      <a id="submit" href="#" onclick="launchSearch(); return false;"><img src="/img/search.png" /></a>
      <a id="tail" href="#" onclick="toggleTailSearch(); return false;">tail -f</a>
      <div id="connectionStatus"></div>
</div>
<div class="results">
    <div class="results_header">
        <div id="resultsMessage"></div>
        <div id="searchFacets"></div>
        <div id="logsTimeline" style="width: 100%; height: 100px"></div>
    </div>
    <div id="searchResults">
        <table>
            <thead>
                <tr>
                    <th class="num"></th>
                    <th class="date">Date</th>
                    <th class="thread">Thread</th>
                    <th class="level">Level</th>
                    <th class="logger">Logger</th>
                    <th class="message">Message</th>
                </tr>
            </thead>
            <tbody id="searchResultsContent">
            </tbody>
        </table>
    </div>
</div>
